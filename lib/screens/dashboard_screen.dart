import 'dart:async';
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:easy_localization/easy_localization.dart';
import 'package:url_launcher/url_launcher.dart';
import 'login_screen.dart'; 
import 'search_screen.dart'; 
import 'tips_screen.dart'; 
import 'edit_profile_screen.dart';

class DashboardScreen extends StatefulWidget {
  const DashboardScreen({super.key});
  @override
  State<DashboardScreen> createState() => _DashboardScreenState();
}

class _DashboardScreenState extends State<DashboardScreen> {
  int _currentIndex = 0; 
  String _userName = "مستخدم"; String _bloodType = "?"; String _city = ""; String _area = ""; String _phone = ""; int _donationCount = 0; DateTime? _lastDonationDate; Timer? _timer; String _timeLeft = ""; bool _canDonate = true; bool _isAvailable = true;

  @override
  void initState() { super.initState(); _getUserData(); _timer = Timer.periodic(const Duration(seconds: 1), (timer) => _updateCountdown()); }
  @override
  void dispose() { _timer?.cancel(); super.dispose(); }

  Future<void> _getUserData() async {
    final user = Supabase.instance.client.auth.currentUser;
    if (user != null) {
      final data = await Supabase.instance.client.from('profiles').select().eq('id', user.id).single();
      setState(() { _userName = data['full_name'] ?? "مستخدم"; _bloodType = data['blood_type'] ?? "?"; _city = data['city'] ?? ""; _area = data['area'] ?? ""; _phone = data['phone_number'] ?? ""; _donationCount = data['donation_count'] ?? 0; _isAvailable = data['is_available'] ?? true; if (data['last_donation_date'] != null) _lastDonationDate = DateTime.parse(data['last_donation_date']); });
      _updateCountdown();
    }
  }

  Future<void> _toggleAvailability(bool value) async {
    final user = Supabase.instance.client.auth.currentUser;
    if (user != null) { setState(() => _isAvailable = value); await Supabase.instance.client.from('profiles').update({'is_available': value}).eq('id', user.id); }
  }

  Future<void> _registerDonation() async {
    final user = Supabase.instance.client.auth.currentUser;
    if (user == null) return;
    bool? confirm = await showDialog(context: context, builder: (context) => Dialog(shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)), child: Container(padding: const EdgeInsets.all(20), decoration: BoxDecoration(borderRadius: BorderRadius.circular(20), color: Colors.white), child: Column(mainAxisSize: MainAxisSize.min, children: [const Icon(Icons.volunteer_activism, color: Color(0xFFE63946), size: 50), const SizedBox(height: 15), Text(tr("confirm_donation_title"), style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold, fontFamily: GoogleFonts.cairo().fontFamily)), const SizedBox(height: 10), Text(tr("confirm_donation_msg"), textAlign: TextAlign.center, style: TextStyle(color: Colors.grey[700], fontFamily: GoogleFonts.cairo().fontFamily)), const SizedBox(height: 30), Container(width: double.infinity, padding: const EdgeInsets.all(15), decoration: BoxDecoration(color: const Color(0xFFF1F8E9), borderRadius: BorderRadius.circular(15), border: Border.all(color: Colors.green.shade200)), child: Column(children: [Text("﷽", style: GoogleFonts.amiri(fontSize: 14, color: Colors.green[800])), const SizedBox(height: 5), Text(tr("quran_verse"), textAlign: TextAlign.center, style: GoogleFonts.amiri(fontSize: 18, color: Colors.green[900], fontWeight: FontWeight.bold)), const SizedBox(height: 5), Text(tr("surah_name"), style: TextStyle(fontSize: 12, color: Colors.green[700]))])), const SizedBox(height: 30), Row(children: [Expanded(child: OutlinedButton(onPressed: () => Navigator.pop(context, false), style: OutlinedButton.styleFrom(padding: const EdgeInsets.symmetric(vertical: 12), shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10))), child: Text(tr("cancel"), style: TextStyle(fontFamily: GoogleFonts.cairo().fontFamily)))), const SizedBox(width: 10), Expanded(child: ElevatedButton(onPressed: () => Navigator.pop(context, true), style: ElevatedButton.styleFrom(backgroundColor: const Color(0xFFE63946), foregroundColor: Colors.white, padding: const EdgeInsets.symmetric(vertical: 12), shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10))), child: Text(tr("confirm_yes"), style: TextStyle(fontFamily: GoogleFonts.cairo().fontFamily, fontWeight: FontWeight.bold))))])]))));
    if (confirm == true) {
      try { final now = DateTime.now().toIso8601String(); await Supabase.instance.client.from('profiles').update({'donation_count': _donationCount + 1, 'last_donation_date': now}).eq('id', user.id); setState(() { _donationCount++; _lastDonationDate = DateTime.now(); }); _updateCountdown(); if (mounted) _showHeroBadge(); } catch (e) { ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("حدث خطأ"), backgroundColor: Colors.red)); }
    }
  }

  void _showHeroBadge() {
    showDialog(context: context, barrierDismissible: false, builder: (context) => Dialog(backgroundColor: Colors.transparent, child: Column(mainAxisSize: MainAxisSize.min, children: [Container(padding: const EdgeInsets.all(25), decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(25), boxShadow: [BoxShadow(color: Colors.black26, blurRadius: 20, spreadRadius: 5)]), child: Column(children: [const CircleAvatar(radius: 40, backgroundColor: Color(0xFFFFD700), child: Icon(Icons.workspace_premium, color: Colors.white, size: 50)), const SizedBox(height: 15), Text(tr("hero_badge_title"), style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold, color: const Color(0xFFE63946), fontFamily: GoogleFonts.cairo().fontFamily)), const SizedBox(height: 10), Text("${tr("i_am")} $_userName\n${tr("hero_badge_msg")}", textAlign: TextAlign.center, style: TextStyle(fontSize: 16, height: 1.5, fontFamily: GoogleFonts.cairo().fontFamily)), const SizedBox(height: 20), const Divider(), const SizedBox(height: 10), Row(mainAxisAlignment: MainAxisAlignment.center, children: [Text("#Wareed", style: TextStyle(color: Colors.grey[600], fontWeight: FontWeight.bold)), const SizedBox(width: 15), Text("#BloodDonation", style: TextStyle(color: Colors.grey[600], fontWeight: FontWeight.bold))])])), const SizedBox(height: 20), Row(mainAxisAlignment: MainAxisAlignment.center, children: [FloatingActionButton.extended(onPressed: () => Navigator.pop(context), backgroundColor: Colors.white, foregroundColor: Colors.black, icon: const Icon(Icons.close), label: Text(tr("close"))), const SizedBox(width: 15), FloatingActionButton.extended(onPressed: () { Navigator.pop(context); ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text(tr("screenshot_hint")), backgroundColor: Colors.green, duration: const Duration(seconds: 4))); }, backgroundColor: const Color(0xFF25D366), label: Text(tr("share")), icon: const Icon(Icons.share))])])));
  }

  Future<void> _cancelDonation() async {
    final user = Supabase.instance.client.auth.currentUser; if (user == null) return;
    bool? confirm = await showDialog(context: context, builder: (context) => AlertDialog(title: const Text("إلغاء التبرع"), content: const Text("هل تريد إلغاء التبرع الأخير؟"), actions: [TextButton(onPressed: () => Navigator.pop(context, false), child: const Text("لا")), TextButton(onPressed: () => Navigator.pop(context, true), child: const Text("نعم"))]));
    if (confirm == true) { await Supabase.instance.client.from('profiles').update({'donation_count': (_donationCount > 0) ? _donationCount - 1 : 0, 'last_donation_date': null}).eq('id', user.id); setState(() { if (_donationCount > 0) _donationCount--; _lastDonationDate = null; _canDonate = true; _timeLeft = ""; }); ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text(tr("donation_cancelled")), backgroundColor: Colors.orange)); }
  }

  void _updateCountdown() {
    if (_lastDonationDate == null) { setState(() { _canDonate = true; _timeLeft = ""; }); return; }
    final now = DateTime.now(); final nextDonationDate = _lastDonationDate!.add(const Duration(days: 90));
    if (now.isAfter(nextDonationDate)) { setState(() { _canDonate = true; _timeLeft = ""; }); } 
    else { final diff = nextDonationDate.difference(now); setState(() { _canDonate = false; _timeLeft = "${diff.inDays} يوم\n${diff.inHours % 24} : ${diff.inMinutes % 60} : ${diff.inSeconds % 60}"; }); }
  }

  @override
  Widget build(BuildContext context) {
    final List<Widget> pages = [ _buildHomePage(), const SearchScreen(), _buildProfilePage() ];
    return Scaffold(backgroundColor: const Color(0xFFF8F9FA), appBar: _currentIndex == 0 ? _buildAppBar() : null, body: pages[_currentIndex], bottomNavigationBar: Container(decoration: BoxDecoration(boxShadow: [BoxShadow(color: Colors.grey.withOpacity(0.1), blurRadius: 20)]), child: BottomNavigationBar(currentIndex: _currentIndex, onTap: (index) => setState(() => _currentIndex = index), backgroundColor: Colors.white, selectedItemColor: const Color(0xFFE63946), unselectedItemColor: Colors.grey, showUnselectedLabels: true, type: BottomNavigationBarType.fixed, items: [BottomNavigationBarItem(icon: const Icon(Icons.home_rounded), label: tr("nav_home")), BottomNavigationBarItem(icon: const Icon(Icons.search_rounded), label: tr("nav_search")), BottomNavigationBarItem(icon: const Icon(Icons.person_rounded), label: tr("nav_profile"))])));
  }

  AppBar _buildAppBar() {
    return AppBar(backgroundColor: Colors.transparent, elevation: 0, title: Row(children: [CircleAvatar(backgroundColor: const Color(0xFFE63946).withOpacity(0.1), child: const Icon(Icons.person, color: Color(0xFFE63946))), const SizedBox(width: 10), Column(crossAxisAlignment: CrossAxisAlignment.start, children: [Text(tr("welcome"), style: TextStyle(color: Colors.grey, fontSize: 12)), Text(_userName, style: const TextStyle(color: Colors.black, fontSize: 16, fontWeight: FontWeight.bold))])]));
  }

  Widget _buildHomePage() {
    return SingleChildScrollView(padding: const EdgeInsets.all(20), child: Column(children: [Container(width: double.infinity, padding: const EdgeInsets.all(25), decoration: BoxDecoration(gradient: const LinearGradient(colors: [Color(0xFFE63946), Color(0xFFFF6B6B)]), borderRadius: BorderRadius.circular(25), boxShadow: [BoxShadow(color: const Color(0xFFE63946).withOpacity(0.4), blurRadius: 15, offset: const Offset(0, 8))]), child: Row(mainAxisAlignment: MainAxisAlignment.spaceBetween, children: [Column(crossAxisAlignment: CrossAxisAlignment.start, children: [Text(tr("your_blood"), style: const TextStyle(color: Colors.white70)), Text(_bloodType, style: GoogleFonts.poppins(color: Colors.white, fontSize: 40, fontWeight: FontWeight.bold))]), Column(children: [const Icon(Icons.favorite, color: Colors.white), Text("$_donationCount مرات", style: const TextStyle(color: Colors.white))])])), const SizedBox(height: 30), if (!_canDonate) Container(width: double.infinity, margin: const EdgeInsets.only(bottom: 20), padding: const EdgeInsets.all(20), decoration: BoxDecoration(gradient: const LinearGradient(colors: [Colors.orange, Colors.deepOrange]), borderRadius: BorderRadius.circular(20), boxShadow: [BoxShadow(color: Colors.orange.withOpacity(0.4), blurRadius: 10, offset: const Offset(0, 5))]), child: Column(children: [Row(mainAxisAlignment: MainAxisAlignment.center, children: [Text(tr("resting_warrior"), style: const TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold)), const SizedBox(width: 10), const Icon(Icons.timer, color: Colors.white)]), const SizedBox(height: 10), Container(padding: const EdgeInsets.all(10), decoration: BoxDecoration(color: Colors.white.withOpacity(0.2), borderRadius: BorderRadius.circular(10)), child: Text(_timeLeft, style: GoogleFonts.poppins(fontWeight: FontWeight.bold, color: Colors.white, fontSize: 20), textAlign: TextAlign.center)), const SizedBox(height: 10), TextButton.icon(onPressed: _cancelDonation, icon: const Icon(Icons.undo, size: 16, color: Colors.white), label: Text(tr("cancel"), style: const TextStyle(color: Colors.white)))])) , Row(children: [Expanded(child: _buildActionButton(title: _canDonate ? "donate_now" : "resting_warrior", subtitle: "donate_subtitle", icon: Icons.favorite, color: Colors.red.shade50, iconColor: Colors.red, onTap: _canDonate ? _registerDonation : (){})), const SizedBox(width: 10), Expanded(child: _buildActionButton(title: "request_blood", subtitle: "request_subtitle", icon: Icons.search, color: Colors.blue.shade50, iconColor: Colors.blue, onTap: () => setState(() => _currentIndex = 1)))]), const SizedBox(height: 20), GestureDetector(onTap: () => Navigator.push(context, MaterialPageRoute(builder: (context) => const TipsScreen())), child: Container(width: double.infinity, height: 100, decoration: BoxDecoration(borderRadius: BorderRadius.circular(20), gradient: const LinearGradient(colors: [Color(0xFF9C27B0), Color(0xFFE040FB)], begin: Alignment.topLeft, end: Alignment.bottomRight), boxShadow: [BoxShadow(color: Colors.purple.withOpacity(0.3), blurRadius: 10, offset: const Offset(0, 5))]), child: Stack(children: [Positioned(right: -20, bottom: -20, child: Icon(Icons.medical_services_outlined, size: 120, color: Colors.white.withOpacity(0.15))), Padding(padding: const EdgeInsets.all(20), child: Row(children: [Container(padding: const EdgeInsets.all(10), decoration: BoxDecoration(color: Colors.white.withOpacity(0.2), borderRadius: BorderRadius.circular(12)), child: const Icon(Icons.health_and_safety, color: Colors.white, size: 30)), const SizedBox(width: 15), Column(crossAxisAlignment: CrossAxisAlignment.start, mainAxisAlignment: MainAxisAlignment.center, children: [Text(tr("medical_tips_title"), style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold, fontFamily: GoogleFonts.cairo().fontFamily)), Text(tr("medical_tips_subtitle"), style: TextStyle(color: Colors.white.withOpacity(0.9), fontSize: 12, fontFamily: GoogleFonts.cairo().fontFamily))])]))]))), const SizedBox(height: 30), Text(tr("recent_requests"), style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, fontFamily: GoogleFonts.cairo().fontFamily)), const SizedBox(height: 15), Center(child: Column(children: [Icon(Icons.inbox_rounded, size: 50, color: Colors.grey[300]), Text("لا توجد طلبات حالياً", style: TextStyle(color: Colors.grey[400]))]))]));
  }

  Widget _buildActionButton({required String title, required String subtitle, required IconData icon, required Color color, required Color iconColor, required VoidCallback onTap}) { return GestureDetector(onTap: onTap, child: Container(padding: const EdgeInsets.all(20), decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(20)), child: Column(children: [Icon(icon, color: iconColor), Text(tr(title), textAlign: TextAlign.center, style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16, fontFamily: GoogleFonts.cairo().fontFamily)), Text(tr(subtitle), textAlign: TextAlign.center, style: TextStyle(color: Colors.grey, fontSize: 12, fontFamily: GoogleFonts.cairo().fontFamily))]))); }

  Widget _buildProfilePage() {
    return ListView(padding: const EdgeInsets.all(20), children: [const SizedBox(height: 20), Center(child: Column(children: [Stack(children: [const CircleAvatar(radius: 50, backgroundColor: Color(0xFFE63946), child: Icon(Icons.person, size: 50, color: Colors.white)), Positioned(bottom: 0, right: 0, child: GestureDetector(onTap: () async { final result = await Navigator.push(context, MaterialPageRoute(builder: (context) => const EditProfileScreen())); if (result == true) _getUserData(); }, child: Container(padding: const EdgeInsets.all(8), decoration: const BoxDecoration(color: Colors.blue, shape: BoxShape.circle), child: const Icon(Icons.edit, size: 18, color: Colors.white))))]), const SizedBox(height: 10), Text(_userName, style: const TextStyle(fontSize: 22, fontWeight: FontWeight.bold)), Text("$_city - $_area", style: const TextStyle(color: Colors.grey))])), const SizedBox(height: 30), _buildProfileItem(Icons.bloodtype, tr("your_blood"), _bloodType), _buildProfileItem(Icons.phone, tr("phone_label"), _phone), _buildProfileItem(Icons.location_city, tr("city_hint"), _city), _buildProfileItem(Icons.map, tr("area_hint"), _area), SwitchListTile(title: Text(tr("availability_status"), style: const TextStyle(fontWeight: FontWeight.bold)), subtitle: Text(_isAvailable ? tr("available") : tr("unavailable"), style: TextStyle(color: _isAvailable ? Colors.green : Colors.red)), value: _isAvailable, activeColor: Colors.green, onChanged: (val) => _toggleAvailability(val)), const Divider(), ListTile(leading: const Icon(Icons.telegram, color: Colors.blue), title: Text(tr("contact_founder")), subtitle: Text(tr("suggestions")), trailing: const Icon(Icons.arrow_forward_ios, size: 16), onTap: () async { final Uri url = Uri.parse("https://t.me/Wareed_admin"); if (!await launchUrl(url, mode: LaunchMode.externalApplication)) ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("لا يمكن فتح الرابط"))); }), ListTile(leading: const Icon(Icons.logout, color: Colors.red), title: Text(tr("logout"), style: const TextStyle(color: Colors.red)), onTap: () async { await Supabase.instance.client.auth.signOut(); if (mounted) Navigator.pushAndRemoveUntil(context, MaterialPageRoute(builder: (context) => const LoginScreen()), (route) => false); }), const SizedBox(height: 40), Container(padding: const EdgeInsets.all(15), decoration: BoxDecoration(color: Colors.grey.shade100, borderRadius: BorderRadius.circular(10)), child: Column(children: [Text(tr("charity_msg"), textAlign: TextAlign.center, style: const TextStyle(color: Colors.grey, fontSize: 12, height: 1.5)), const SizedBox(height: 10), Text(tr("developed_by"), style: TextStyle(color: const Color(0xFFE63946), fontSize: 12, fontWeight: FontWeight.bold, fontFamily: GoogleFonts.cairo().fontFamily))])), const SizedBox(height: 20)]); 
  }

  Widget _buildProfileItem(IconData icon, String title, String value) { return Container(margin: const EdgeInsets.only(bottom: 10), padding: const EdgeInsets.all(15), decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(15)), child: Row(children: [Icon(icon, color: const Color(0xFFE63946)), const SizedBox(width: 15), Column(crossAxisAlignment: CrossAxisAlignment.start, children: [Text(title, style: const TextStyle(color: Colors.grey, fontSize: 12)), Text(value, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 16))])])); }
}